<!DOCTYPE html>
<html lang="si">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ලංකා ඉතිහාසයේ මූලාශ්‍රය</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
        }
        
        body {
            font-family: 'Noto Sans Sinhala', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            padding: 30px;
        }
        
        h1 {
            text-align: center;
            color: #2d3748;
            margin-bottom: 30px;
            font-size: 2em;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            font-size: 1.2em;
            color: #667eea;
        }
        
        .error {
            text-align: center;
            padding: 40px;
            font-size: 1.1em;
            color: #f5576c;
            background: #ffe0e0;
            border-radius: 10px;
            margin: 20px 0;
        }
        
        .search-container {
            position: sticky;
            top: 0;
            background: white;
            z-index: 100;
            padding: 20px 0 10px 0;
            margin: -30px -30px 25px -30px;
            padding-left: 30px;
            padding-right: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            border-radius: 20px 20px 0 0;
        }
        
        #searchBox {
            width: 100%;
            padding: 15px 20px;
            font-size: 1em;
            border: 2px solid #667eea;
            border-radius: 50px;
            outline: none;
            transition: all 0.3s;
        }
        
        #searchBox:focus {
            border-color: #764ba2;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .search-results-info {
            text-align: center;
            margin: 10px 0;
            font-size: 0.9em;
            color: #4a5568;
            font-weight: 500;
        }
        
        .search-nav-buttons {
            display: none;
            gap: 8px;
            justify-content: center;
            margin-top: 10px;
        }
        
        .search-nav-btn {
            padding: 8px 14px;
            font-size: 1.2em;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s;
            min-width: 45px;
        }
        
        .search-nav-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }
        
        .search-nav-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
            transform: none;
        }
        
        .note-area {
            background: #f7fafc;
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 25px;
            border: 2px solid #e2e8f0;
            min-height: 300px;
            line-height: 1.8;
            font-size: 1em;
        }
        
        .note-area[contenteditable="true"] {
            background: #fff;
            border-color: #667eea;
            cursor: text;
        }
        
        .highlight {
            background-color: #ffd700;
            padding: 2px 4px;
            border-radius: 3px;
            font-weight: bold;
        }
        
        .current-highlight {
            background-color: #ff6b6b !important;
            box-shadow: 0 0 10px rgba(255, 107, 107, 0.5);
        }
        
        .cross-ref-term {
            color: #2563eb;
            font-weight: 600;
            cursor: pointer;
            text-decoration: underline;
            text-decoration-style: solid;
            text-underline-offset: 3px;
            transition: all 0.2s;
        }
        
        .cross-ref-term:hover {
            color: #1d4ed8;
            background-color: rgba(37, 99, 235, 0.1);
            border-radius: 3px;
        }
        
        .tooltip {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.4);
            z-index: 10001;
            max-width: 90vw;
            width: 400px;
            max-height: 80vh;
            overflow-y: auto;
            font-size: 0.95em;
            line-height: 1.6;
            display: none;
            animation: tooltipFadeIn 0.3s ease-out;
            cursor: pointer;
        }
        
        .tooltip-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 10000;
            display: none;
            animation: overlayFadeIn 0.3s ease-out;
        }
        
        @keyframes overlayFadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }
        
        .tooltip::-webkit-scrollbar {
            width: 8px;
        }
        
        .tooltip::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
        }
        
        .tooltip::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.5);
            border-radius: 10px;
        }
        
        .tooltip::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.7);
        }
        
        @media (max-width: 768px) {
            .tooltip {
                max-width: 85vw;
                width: auto;
                padding: 18px;
                font-size: 0.9em;
            }
        }
        
        @keyframes tooltipFadeIn {
            from {
                opacity: 0;
                transform: translateY(-5px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .button-container {
            position: fixed;
            bottom: 10px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 5px;
            justify-content: center;
            background: rgba(255, 255, 255, 0.95);
            padding: 5px 5px;
            border-radius: 50px;
            box-shadow: 0 8px 30px rgba(0,0,0,0.3);
            z-index: 1000;
            backdrop-filter: blur(10px);
        }
        
        button {
            padding: 5px;
            width: 25px;
            height: 25px;
            font-size: 1.3em;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: bold;
            color: white;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.3);
        }
        
        button:active {
            transform: translateY(0);
        }
        
        #increaseBtn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        #decreaseBtn {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }
        
        #editBtn {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }
        
        #saveBtn {
            background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
            display: none;
        }

        .book-link {
            display: block;
            text-align: center;
            padding: 15px 25px;
            margin: 0 0 20px 0;
            background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
            color: white;
            text-decoration: none;
            border-radius: 15px;
            font-weight: 600;
            font-size: 1.1em;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }

        .book-link:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.3);
        }
        
        @media (max-width: 768px) {
            .container {
                padding: 20px;
            }
        
            h1 {
                font-size: 1.5em;
            }
            
            .note-area {
                padding: 15px;
                font-size: 0.95em;
            }
            
            button {
                padding: 10px 18px;
                font-size: 0.9em;
            }
        }
    </style>
</head>
<body>
   <div class="container">
    <h1 id="pageTitle">ලංකා ඉතිහාසයේ මූලාශ්‍රය</h1>
    
    <a href="https://amilaeduhelp.github.io/book-price/" target="_blank" class="book-link">
        📚 මෙම සටහන ඇතුළු සම්පූර්ණ සටහන් ඇතුළත් මුද්‍රිත පොත ලබාගැනීම සඳහා මෙතැනින් පිවිසෙන්න
    </a>
    
    <div class="search-container">
        <input type="text" id="searchBox" placeholder="සෙවීමට වචනයක් ඇතුලත් කරන්න...">
        <div class="search-results-info" id="searchInfo"></div>
        <div class="search-nav-buttons" id="searchNavButtons">
            <button class="search-nav-btn" id="prevBtn">▲</button>
            <button class="search-nav-btn" id="nextBtn">▼</button>
        </div>
    </div>
    
    <div class="tooltip-overlay" id="tooltipOverlay"></div>
    <div class="tooltip" id="tooltip"></div>
    
    <div class="note-area" id="noteArea">
        <div class="loading">පාඩම පූරණය වෙමින් පවතී...</div>
    </div>
    
    <div class="button-container">
        <button id="increaseBtn">+</button>
        <button id="decreaseBtn">-</button>
        <button id="editBtn">E</button>
        <button id="saveBtn">S</button>
    </div>
   </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        const SUPABASE_URL = 'https://uqgzlaxsnknheoerbfus.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVxZ3psYXhzbmtuaGVvZXJiZnVzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDQ4MDQzMTEsImV4cCI6MjA2MDM4MDMxMX0.O5dNUizqZ5kfwTs0mHLEorqOAqjZFjWakp2Q484MKEk';
        
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        document.addEventListener('contextmenu', function(e) {
            e.preventDefault();
            return false;
        });

        document.addEventListener('keydown', function(e) {
            if ((e.ctrlKey || e.metaKey) && (e.key === 'a' || e.key === 'c' || e.key === 'x' || e.key === 'A' || e.key === 'C' || e.key === 'X')) {
                const noteArea = document.getElementById('noteArea');
                if (!noteArea.isContentEditable || noteArea.contentEditable === 'false') {
                    e.preventDefault();
                    return false;
                }
            }
        });

        let fontSize = 16;
        let isEditing = false;
        let originalContent = '';
        let currentHighlightIndex = 0;
        let highlights = [];
        let currentArticleId = null;
        let originalHTML = '';
        let learnXTerms = {};

        const searchBox = document.getElementById('searchBox');
        const noteArea = document.getElementById('noteArea');
        const increaseBtn = document.getElementById('increaseBtn');
        const decreaseBtn = document.getElementById('decreaseBtn');
        const editBtn = document.getElementById('editBtn');
        const saveBtn = document.getElementById('saveBtn');
        const searchInfo = document.getElementById('searchInfo');
        const searchNavButtons = document.getElementById('searchNavButtons');
        const prevBtn = document.getElementById('prevBtn');
        const nextBtn = document.getElementById('nextBtn');
        const tooltip = document.getElementById('tooltip');
        const tooltipOverlay = document.getElementById('tooltipOverlay');
        const pageTitle = document.getElementById('pageTitle');

        async function loadLearnXTerms() {
            try {
                console.log('Loading LearnX pedia terms...');
                const { data, error } = await supabase
                    .from('learnX pedia')
                    .select('id, word, meaning, slug');
                
                if (error) {
                    console.error('LearnX pedia error:', error);
                    throw error;
                }
                
                if (data) {
                    data.forEach(item => {
                        learnXTerms[item.word] = {
                            meaning: item.meaning,
                            slug: item.slug,
                            id: item.id
                        };
                    });
                    console.log('LearnX terms loaded successfully:', Object.keys(learnXTerms).length);
                }
            } catch (error) {
                console.error('Error loading LearnX terms:', error);
            }
        }

        async function loadArticle(slug = null) {
            try {
                console.log('Loading article...');
                let query = supabase.from('Historynt').select('*');
                
                if (slug) {
                    query = query.eq('slug', slug);
                } else {
                    query = query.order('created_at', { ascending: true }).limit(1);
                }
                
                const { data, error } = await query;
                
                if (error) {
                    console.error('Article load error:', error);
                    throw error;
                }
                
                if (data && data.length > 0) {
                    const article = data[0];
                    currentArticleId = article.id;
                    pageTitle.textContent = article.title;
                    noteArea.innerHTML = article.content;
                    originalHTML = article.content;
                    originalContent = noteArea.textContent;
                    applyCrossReferences();
                    console.log('Article loaded successfully');
                } else {
                    noteArea.innerHTML = '<div class="error">පාඩම හමු නොවිණි.</div>';
                }
            } catch (error) {
                console.error('Error loading article:', error);
                noteArea.innerHTML = '<div class="error">දෝෂයක්: ' + error.message + '</div>';
            }
        }

        function applyCrossReferences() {
            let content = noteArea.innerHTML;
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = content;
            
            const existingTerms = tempDiv.querySelectorAll('.cross-ref-term');
            existingTerms.forEach(term => {
                term.outerHTML = term.textContent;
            });
            
            content = tempDiv.innerHTML;
            
            const sortedTerms = Object.keys(learnXTerms).sort((a, b) => b.length - a.length);
            
            for (const term of sortedTerms) {
                const termData = learnXTerms[term];
                const escapedTerm = term.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
                
                const tempContainer = document.createElement('div');
                tempContainer.innerHTML = content;
                
                function replaceInNodes(node) {
                    if (node.nodeType === Node.TEXT_NODE) {
                        const text = node.textContent;
                        const regex = new RegExp('(^|\\s|[.,;:!?()\\-])' + escapedTerm + '(?=\\s|[.,;:!?()\\-]|$)', 'gi');
                        const matches = text.match(regex);
                        if (matches) {
                            const span = document.createElement('span');
                            span.innerHTML = text.replace(regex, function(match, prefix) {
                                return prefix + '<span class="cross-ref-term" data-meaning="' + termData.meaning.replace(/"/g, '&quot;') + '" data-slug="' + termData.slug.replace(/"/g, '&quot;') + '">' + term + '</span>';
                            });
                            node.parentNode.replaceChild(span, node);
                        }
                    } else if (node.nodeType === Node.ELEMENT_NODE && node.className !== 'cross-ref-term' && node.tagName !== 'SCRIPT' && node.tagName !== 'STYLE') {
                        Array.from(node.childNodes).forEach(child => replaceInNodes(child));
                    }
                }
                
                Array.from(tempContainer.childNodes).forEach(child => replaceInNodes(child));
                content = tempContainer.innerHTML;
            }
            
            noteArea.innerHTML = content;
            attachCrossRefListeners();
        }

        function attachCrossRefListeners() {
            const terms = document.querySelectorAll('.cross-ref-term');
            terms.forEach(term => {
                term.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const meaning = this.getAttribute('data-meaning');
                    const slug = this.getAttribute('data-slug');
                    showTooltip(this, meaning, slug);
                });
            });
        }

        function showTooltip(element, text, slug) {
            tooltip.textContent = text;
            tooltip.style.display = 'block';
            tooltipOverlay.style.display = 'block';
            
            document.body.style.overflow = 'hidden';
            
            tooltip.onclick = function() {
                if (slug) {
                    window.location.href = '?slug=' + slug;
                }
            };
        }

        function hideTooltip() {
            tooltip.style.display = 'none';
            tooltipOverlay.style.display = 'none';
            document.body.style.overflow = '';
        }

        tooltipOverlay.addEventListener('click', hideTooltip);

        document.addEventListener('click', function(e) {
            if (!e.target.classList.contains('cross-ref-term') && !tooltip.contains(e.target)) {
                hideTooltip();
            }
        });

        searchBox.addEventListener('input', function() {
            const searchTerm = this.value.trim();
            
            if (!searchTerm) {
                noteArea.innerHTML = originalHTML;
                applyCrossReferences();
                searchInfo.textContent = '';
                searchNavButtons.style.display = 'none';
                highlights = [];
                currentHighlightIndex = 0;
                return;
            }
            
            const text = noteArea.textContent;
            const regex = new RegExp('(' + searchTerm.replace(/[.*+?^${}()|[\]\\]/g, '\\$&') + ')', 'gi');
            const matches = text.match(regex);
            
            if (matches && matches.length > 0) {
                let content = originalHTML;
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = content;
                
                function highlightTextNodes(node) {
                    if (node.nodeType === Node.TEXT_NODE) {
                        const text = node.textContent;
                        if (regex.test(text)) {
                            const span = document.createElement('span');
                            span.innerHTML = text.replace(regex, '<span class="highlight">$1</span>');
                            node.parentNode.replaceChild(span, node);
                            
                            while (span.firstChild) {
                                span.parentNode.insertBefore(span.firstChild, span);
                            }
                            span.remove();
                        }
                    } else if (node.nodeType === Node.ELEMENT_NODE && node.tagName !== 'SCRIPT' && node.tagName !== 'STYLE') {
                        Array.from(node.childNodes).forEach(child => highlightTextNodes(child));
                    }
                }
                
                highlightTextNodes(tempDiv);
                noteArea.innerHTML = tempDiv.innerHTML;
                applyCrossReferences();
                
                highlights = Array.from(document.querySelectorAll('.highlight'));
                currentHighlightIndex = 0;
                
                if (highlights.length > 0) {
                    highlights[0].classList.add('current-highlight');
                    highlights[0].scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
                
                searchInfo.textContent = 'ප්‍රතිඵල ' + highlights.length + ' ක් හමු විය';
                
                if (highlights.length > 1) {
                    searchNavButtons.style.display = 'flex';
                    updateNavButtons();
                } else {
                    searchNavButtons.style.display = 'none';
                }
            } else {
                noteArea.innerHTML = originalHTML;
                applyCrossReferences();
                searchInfo.textContent = 'ප්‍රතිඵල හමු නොවිය';
                searchNavButtons.style.display = 'none';
                highlights = [];
                currentHighlightIndex = 0;
            }
        });

        function updateNavButtons() {
            prevBtn.disabled = currentHighlightIndex === 0;
            nextBtn.disabled = currentHighlightIndex === highlights.length - 1;
        }

        function navigateHighlights(direction) {
            if (highlights.length === 0) return;
            
            highlights[currentHighlightIndex].classList.remove('current-highlight');
            
            if (direction === 'next' && currentHighlightIndex < highlights.length - 1) {
                currentHighlightIndex++;
            } else if (direction === 'prev' && currentHighlightIndex > 0) {
                currentHighlightIndex--;
            }
            
            highlights[currentHighlightIndex].classList.add('current-highlight');
            highlights[currentHighlightIndex].scrollIntoView({ behavior: 'smooth', block: 'center' });
            updateNavButtons();
        }

        prevBtn.addEventListener('click', function() {
            navigateHighlights('prev');
        });

        nextBtn.addEventListener('click', function() {
            navigateHighlights('next');
        });

        increaseBtn.addEventListener('click', function() {
            fontSize += 2;
            noteArea.style.fontSize = fontSize + 'px';
        });

        decreaseBtn.addEventListener('click', function() {
            if (fontSize > 10) {
                fontSize -= 2;
                noteArea.style.fontSize = fontSize + 'px';
            }
        });

        editBtn.addEventListener('click', function() {
            const password = prompt('මුරපදය ඇතුළත් කරන්න:');
            
            if (password !== 'Lakmini79') {
                alert('වැරදි මුරපදයක්!');
                return;
            }
            
            isEditing = true;
            noteArea.contentEditable = 'true';
            noteArea.style.userSelect = 'text';
            noteArea.style.webkitUserSelect = 'text';
            noteArea.style.mozUserSelect = 'text';
            noteArea.focus();
            editBtn.style.display = 'none';
            saveBtn.style.display = 'inline-block';
        });
        
        saveBtn.addEventListener('click', async function() {
            if (!currentArticleId) {
                alert('සුරැකීමට ලිපියක් නැත!');
                return;
            }
            
            try {
                const { error } = await supabase
                    .from('Historynt')
                    .update({ content: noteArea.innerHTML })
                    .eq('id', currentArticleId);
                
                if (error) throw error;
                
                alert('ලිපිය සුරකින ලදී!');
                
                isEditing = false;
                noteArea.contentEditable = 'false';
                noteArea.style.userSelect = 'none';
                noteArea.style.webkitUserSelect = 'none';
                noteArea.style.mozUserSelect = 'none';
                originalHTML = noteArea.innerHTML;
                originalContent = noteArea.textContent;
                editBtn.style.display = 'inline-block';
                saveBtn.style.display = 'none';
                applyCrossReferences();
            } catch (error) {
                console.error('Error saving article:', error);
                alert('දෝෂයක්: ' + error.message);
            }
        });

        window.addEventListener('DOMContentLoaded', async function() {
            await loadLearnXTerms();
            const urlParams = new URLSearchParams(window.location.search);
            const slug = urlParams.get('slug') || 'slhis001';
            console.log('Loading article with slug:', slug);
            await loadArticle(slug);
        });
      
    </script>
</body>
</html>
