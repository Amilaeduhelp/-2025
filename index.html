<!DOCTYPE html>
<html lang="si">
<head>
<meta charset="UTF-8">
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>LearnX</title>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }

body {
  font-family: 'Noto Sans Sinhala', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  display: flex;
  justify-content: center;
  align-items: center;
  min-height: 100vh;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  padding: 1rem;
}

.container {
  background: white;
  padding: 2.5rem;
  border-radius: 12px;
  box-shadow: 0 15px 35px rgba(0,0,0,0.3);
  width: 100%;
  max-width: 420px;
  animation: slideIn 0.4s ease-out;
}

@keyframes slideIn {
  from { opacity: 0; transform: translateY(-20px); }
  to { opacity: 1; transform: translateY(0); }
}

.logo {
  text-align: center;
  font-size: 3.5rem;
  margin-bottom: 1rem;
}

h1 {
  color: #333;
  text-align: center;
  margin-bottom: 0.5rem;
  font-size: 1.8rem;
  font-weight: 600;
}

.subtitle {
  text-align: center;
  color: #666;
  margin-bottom: 2rem;
  font-size: 0.95rem;
}

.countdown-box {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  padding: 1rem;
  border-radius: 8px;
  margin-bottom: 1.5rem;
  text-align: center;
  display: none;
  animation: fadeIn 0.5s;
}

.countdown-box.show {
  display: block;
}

.countdown-box h3 {
  font-size: 0.9rem;
  margin-bottom: 0.5rem;
  opacity: 0.9;
}

.countdown-timer {
  font-size: 1.5rem;
  font-weight: 700;
  display: flex;
  justify-content: center;
  gap: 1rem;
  margin-top: 0.5rem;
}

.time-unit {
  display: flex;
  flex-direction: column;
  align-items: center;
}

.time-value {
  font-size: 1.8rem;
  font-weight: 700;
}

.time-label {
  font-size: 0.7rem;
  opacity: 0.8;
  margin-top: 0.2rem;
}

.input-group {
  margin-bottom: 1rem;
}

label {
  display: block;
  margin-bottom: 0.5rem;
  color: #555;
  font-size: 0.9rem;
  font-weight: 500;
}

input {
  width: 100%;
  padding: 0.9rem 1rem;
  border: 2px solid #e0e0e0;
  border-radius: 8px;
  font-size: 1rem;
  transition: all 0.3s;
  background: #f9f9f9;
}

input:focus {
  outline: none;
  border-color: #667eea;
  background: white;
  box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
}

button {
  width: 100%;
  padding: 0.9rem;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  border: none;
  border-radius: 8px;
  font-size: 1.05rem;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s;
  margin-top: 0.5rem;
  font-family: 'Noto Sans Sinhala', 'Segoe UI', sans-serif;
}

button:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4); }
button:active { transform: translateY(0); }

.message {
  margin-top: 1rem;
  padding: 0.75rem;
  border-radius: 6px;
  font-size: 0.9rem;
  text-align: center;
  display: none;
  animation: fadeIn 0.3s;
}

@keyframes fadeIn {
  from { opacity: 0; }
  to { opacity: 1; }
}

.message.show { display: block; }
.message.error { background: #ffebee; color: #c62828; border: 1px solid #ef5350; }
.message.success { background: #e8f5e9; color: #2e7d32; border: 1px solid #66bb6a; }

.info {
  margin-top: 1.5rem;
  padding: 1rem;
  background: #f0f4ff;
  border-left: 4px solid #667eea;
  border-radius: 4px;
  font-size: 0.85rem;
  color: #555;
  line-height: 1.5;
}

.info strong { color: #667eea; }

.action-buttons {
  margin-top: 1.5rem;
  display: flex;
  flex-direction: column;
  gap: 0.75rem;
}

.secondary-btn {
  background: white;
  color: #667eea;
  border: 2px solid #667eea;
  font-size: 0.95rem;
  padding: 0.8rem;
  font-weight: 500;
  position: relative;
}

.secondary-btn:hover {
  background: #667eea;
  color: white;
  transform: translateY(-2px);
  box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
}

.whatsapp-btn:hover {
  background: #25D366;
  border-color: #25D366;
  color: white;
}

.news-btn {
  background: linear-gradient(135deg, #FF6B6B 0%, #FF8E53 100%);
  color: white;
  border: none;
}

.news-btn:hover {
  background: linear-gradient(135deg, #FF5252 0%, #FF7043 100%);
  transform: translateY(-2px);
  box-shadow: 0 4px 15px rgba(255, 107, 107, 0.4);
}

.notification-badge {
  position: absolute;
  top: -8px;
  right: -8px;
  background: #FF3838;
  color: white;
  font-size: 0.75rem;
  font-weight: 700;
  padding: 0.25rem 0.5rem;
  border-radius: 12px;
  min-width: 22px;
  text-align: center;
  box-shadow: 0 2px 8px rgba(255, 56, 56, 0.4);
  animation: pulse 2s infinite;
}

@keyframes pulse {
  0%, 100% { transform: scale(1); }
  50% { transform: scale(1.1); }
}

.modal {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0,0,0,0.7);
  z-index: 1000;
  justify-content: center;
  align-items: center;
  animation: fadeIn 0.3s;
}

.modal.show {
  display: flex;
}

.modal-content {
  background: white;
  padding: 2rem;
  border-radius: 12px;
  max-width: 400px;
  width: 90%;
  text-align: center;
  animation: slideIn 0.4s ease-out;
}

.modal-content h2 {
  color: #c62828;
  margin-bottom: 1rem;
}

.modal-content p {
  color: #555;
  margin-bottom: 1.5rem;
  line-height: 1.6;
}

.modal-btn {
  padding: 0.8rem 2rem;
  margin: 0.5rem;
  border-radius: 8px;
  border: none;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s;
  font-family: 'Noto Sans Sinhala', 'Segoe UI', sans-serif;
}

.btn-primary {
  background: #667eea;
  color: white;
}

.btn-primary:hover {
  background: #5568d3;
}

.warning-box {
  margin-top: 1.5rem;
  padding: 1rem;
  background: #fff3e0;
  border-left: 4px solid #ff9800;
  border-radius: 4px;
  font-size: 0.85rem;
  color: #e65100;
  line-height: 1.5;
}
</style>
</head>
<body>

<div class="container">
  <div class="logo">ð</div>
  <h1>LearnX</h1>
  <p class="subtitle">Enter your credentials to continue</p>
  
  <div class="countdown-box" id="countdownBox">
    <h3>â±ï¸ à¶à¶¶à¶à· à¶à·à¶«à·à¶¸ à¶à¶½à· à¶à¶à·à¶­à· à·à¶±à·à¶±à·:</h3>
    <div class="countdown-timer">
      <div class="time-unit">
        <div class="time-value" id="days">0</div>
        <div class="time-label">à¶¯à·à¶±</div>
      </div>
      <div class="time-unit">
        <div class="time-value" id="hours">0</div>
        <div class="time-label">à¶´à·à¶º</div>
      </div>
      <div class="time-unit">
        <div class="time-value" id="minutes">0</div>
        <div class="time-label">à¶¸à·à¶±à·à¶­à·à¶­à·</div>
      </div>
    </div>
  </div>
  
  <div class="input-group">
    <label for="username">Access Code</label>
    <input type="text" id="username" placeholder="Enter access code" autocomplete="username" autofocus>
  </div>
  
  <div class="input-group">
    <label for="password">Password</label>
    <input type="password" id="password" placeholder="Enter password" autocomplete="current-password">
  </div>
  
  <button onclick="verify()">Access Site</button>
  
  <div class="message" id="msg"></div>
  
  <div class="info">
    <strong>â¹ï¸ Need access?</strong><br>
    Contact the administrator to receive your access credentials.
  </div>
  
  <div class="warning-box">
    <strong>â ï¸ Important:</strong> Only one active session per account is allowed. If you login from another device/browser, your current session will be terminated.
  </div>
  <div class="warning-box">
    <strong>â ï¸ à¶à·à·à·à¶¯à¶º à¶ºà·:</strong> à¶à¶¶à¶à· access code à¶à¶ à·à· password à¶à¶ à¶à¶±à·à·à¶­à· à¶à·à¶»à·à¶¸à·à¶±à· à¶à¶¶à¶à· à¶à·à¶«à·à¶¸ à¶´à·à¶»à·à· à¶¯à·à¶±à·à¶¸à·à¶¯à·à¶¸à¶à·à¶±à· à¶­à·à¶»à· à¶à·à¶½à¶à¶à· à¶à¶»à¶±à· à¶à¶­.  à¶­à· à¶¯ à¶¸à·à¶¸ à·à·à¶¶à· à¶à¶©à·à·à¶ºà· à·à·à¶ºà¶½à· à¶¸ à¶­à·à¶»à¶­à·à¶»à· à·à· à·à·à¶à·à·à¶¸à· learnX à·à¶­à· à·à¶± à¶à¶­à¶» à¶à¶±à·à·à¶»à¶ºà·à¶±à· à¶¯à¶­à·à¶­ à¶à¶´à·à¶§à·à¶à·à¶±à·à¶¸à·, à·à¶¸à·à¶¢ à¶¸à·à¶°à·âà¶º à·à¶½ à¶´à¶½ à¶à·à¶»à·à¶¸à· à¶à¶­à·à¶½à· à¶à·à¶¸à¶± à·à· à¶à¶à·à¶»à¶ºà¶ à¶à¶­à·à·à·à¶¸à·à¶à¶¸à· à¶à¶½à·à¶½à¶à¶à¶±à¶º à¶à·à¶»à·à¶¸à¶à· à¶±à·à¶­à· à·à·à¶»à·à¶°à· à·à·. 
  </div>
  
  <div class="action-buttons">
    <button class="secondary-btn news-btn" onclick="window.location.href='news.html'" style="position: relative;">
      ð° à¶à¶½à·à¶­à· à¶¯à·à¶±à·à¶¸
      <span class="notification-badge" id="newsBadge" style="display: none;">0</span>
    </button>
    <button class="secondary-btn" onclick="window.location.href='price.html'">
      Password à¶à¶à¶à· à·à· Access Code à¶à¶à¶à· à¶½à¶¶à· à¶à¶±à·à¶±à· à¶à·à·à· à¶¯?
    </button>
    <button class="secondary-btn" onclick="showContentModal()">
       à¶¸à·à·à· à¶à¶±à·à¶­à¶»à·à¶à¶­ à·à¶±à·à¶±à· à¶¸à·à¶±à·à· à¶¯?
    </button>
    <button class="secondary-btn whatsapp-btn" onclick="window.open('https://wa.me/94716637804', '_blank')">
      ð± Contact
    </button>
  </div>
</div>

<div class="modal" id="logoutModal">
  <div class="modal-content">
    <h2>â ï¸ Session Terminated</h2>
    <p>Another user has logged in with your credentials. Your session has been terminated for security reasons.</p>
    <button class="modal-btn btn-primary" onclick="closeModal()">OK</button>
  </div>
</div>

<div class="modal" id="contentModal">
  <div class="modal-content" style="max-width: 500px; max-height: 80vh; overflow-y: auto;">
    <h2 style="color: #667eea; margin-bottom: 1.5rem;">ð à¶¸à·à·à· à¶à¶±à·à¶­à¶»à·à¶à¶­ à·à¶±à·à¶±à· à¶¸à·à¶±à·à· à¶¯?</h2>
    <div style="text-align: left; color: #555; line-height: 1.8;">
      <ul style="list-style: none; padding: 0;">
        <li style="padding: 0.6rem 0; border-bottom: 1px solid #eee;">â à¶à¶»à·à¶® à·à·à·à¶­à· à¶à¶­à·à·à·à·à¶º à·à·à¶à· à¶¸à·à¶½à·à· (à·à·à¶¸à·à¶±à·âà¶º à¶´à·à· à·à· à¶à·à·à· à¶´à·à·à¶§ à¶à¶¯à·à·à·)</li>
        <li style="padding: 0.6rem 0; border-bottom: 1px solid #eee;">â à¶à·à·à· à¶´à·à· à¶à¶­à·à·à·à·à¶º à·à¶§à·à¶±à· (à·à·âà¶»à· à¶½à¶à¶à· à¶à¶­à·à·à·à·à¶º, à¶ºà·à¶»à·à¶´à· à¶à¶­à·à·à·à·à¶º, à¶à¶±à·à¶¯à·à¶ºà· à¶à¶­à·à·à·à·à¶º)</li>
        <li style="padding: 0.6rem 0; border-bottom: 1px solid #eee;">â à¶à¶¯à¶»à·à· à¶´à·à·à·à¶­à·à¶»à· à¶´à·à¶­ (à·à·à¶¸à·à¶±à·âà¶º à¶´à·à· à·à· à¶à·à·à· à¶´à·à·)</li>
        <li style="padding: 0.6rem 0; border-bottom: 1px solid #eee;">â edupoints (à·à·à¶¸à·à¶±à·âà¶º à¶´à·à· à·à· à¶à·à·à· à¶´à·à· à·à¶³à·à· à¶»à¶ à¶±à·à¶¸à¶º à¶´à·âà¶»à·à·à¶± à¶½à·à·à·à¶¸à¶§ à¶¸à¶à¶´à·à¶±à·à·à·à¶¸)</li>
        <li style="padding: 0.6rem 0; border-bottom: 1px solid #eee;">â à·à·à·à·à·à·à·à¶¯à·âà¶ºà·à¶½ à¶´à·à¶¨à¶¸à·à¶½à· à·à·à·à·à¶­à¶»</li>
        <li style="padding: 0.6rem 0; border-bottom: 1px solid #eee;">â Z-Score (à¶´à·à·à¶à·à¶º à·à·à¶» à¶à·à·à·à¶´à¶ºà¶)</li>
        <li style="padding: 0.6rem 0; border-bottom: 1px solid #eee;">â Job mart (à¶»à·à¶à·à¶ºà· à·à·à·à·à¶­à¶»)</li>
        <li style="padding: 0.6rem 0; border-bottom: 1px solid #eee;">â à¶»à·à¶¢à¶à·à¶»à· à¶½à·à¶à¶±</li>
        <li style="padding: 0.6rem 0; border-bottom: 1px solid #eee;">â à¶¸à·à¶­à·à¶à· à¶ à¶´à·âà¶»à·à·à¶± à¶à·à·à·à¶­à·âà¶» (à¶à·à·à· à¶´à·à· à¶à¶­à·à·à·à·à¶º à·à¶³à·à·)</li>
        <li style="padding: 0.6rem 0; border-bottom: 1px solid #eee;">â Smart à·à·à¶­à·à¶ºà¶¸à· à¶´à·à¶­ (à¶à·à·à· à¶´à·à· à·à· à·à·à¶¸à·à¶±à·âà¶º à¶´à·à· à·à¶³à·à·)</li>
        <li style="padding: 0.6rem 0; border-bottom: 1px solid #eee;">â MCQ test à¶à¶à¶à·à¶±à· à¶à¶¶à· à¶½à¶à·à¶«à· à¶¶à¶½à· à¶à¶±à·à¶±</li>
        <li style="padding: 0.6rem 0; border-bottom: 1px solid #eee;">â à·à·à¶­à·à¶­à·à¶º à·à·à¶¯à·à¶ºà· à¶´à¶»à·à¶à·à·à¶«à¶º</li>
        <li style="padding: 0.6rem 0; border-bottom: 1px solid #eee;">â à¶´à·à¶­à·à·à¶½</li>
        <li style="padding: 0.6rem 0;">â Y-Sub (à·à·à·à·à¶° à·à·à·à¶ºà¶ºà¶±à· à·à·à¶¯à·à¶»à·à¶¸à· à·à·à¶¯à¶à¶­à·à¶à¶¸à·)</li>
      </ul>
    </div>
    <button class="modal-btn btn-primary" onclick="closeContentModal()" style="margin-top: 1.5rem; width: 100%;">à·à¶»à·</button>
  </div>
</div>

<div class="modal" id="expiredModal">
  <div class="modal-content">
    <h2 style="color: #c62828;">â ï¸ à¶à·à¶«à·à¶¸ à¶à¶½à· à¶à¶à·à¶­à· à·à· à¶à¶­</h2>
    <p>à¶à¶¶à¶à· access code à¶à¶ à¶¯à·à¶± 365 à¶à·à¶½à¶º à¶à·à·à¶±à· à·à· à¶à¶­. à¶à¶»à·à¶«à·à¶à¶» à¶±à· access code à¶à¶à¶à· à¶½à¶¶à· à¶à¶±à·à¶±.</p>
    <button class="modal-btn btn-primary" onclick="closeExpiredModal()">à·à¶»à·</button>
  </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
<script>
var config = {
  redirectUrl: "https://amilaeduhelp.github.io/-2025/entrence.html",
  sessionTimeout: 24,
  accountValidityDays: 365
};

var credentials = {
  "ADMIN": { hash: "240be518fabd2724ddb6f04eeb1da5967448d7e831c08c8fa822809f74c720a9", created: "2024-10-11" },
  "CCAC": { hash: "8f49fc41262fc025774655f2cf0dc8b795a5b492f69ce4566c6c11cc58ba202d", created: "2025-10-10" },
  "CUST001": { hash: "03ac674216f3e15c761ee1a5e255f067953623c8b388b4459e13f978d7c846f4", created: "2024-11-29" },
  "CUST002": { hash: "8bb0cf6eb9b17d0f7d22b456f121257dc1254e1f01665370476383ea776df414", created: "2025-03-01" },
  "CUST100": { hash: "dc658816b8b6be963b4ae5ae4c6befcceb8ac9a8f24b02b7ba1f2e33966137e7", created: "2024-11-30" },
  "GAMINI": { hash: "f654e1e4e711d898a37fb539d53fe41b71d15f0e6090aa0ba2090084f5da140b", created: "2025-10-10" },
  "LAK100": { hash: "fd3ae3b595e9df173e5ad2163b1053f7cc606df00629da74958b0acc7a1d32e3", created: "2025-02-10" },
  "RUKSHI": { hash: "9d980933f27f5763decdc1879ade71901aca981c1467feb55d1aaf0b4b4c4f5b", created: "2025-10-10" },
  "USER001": { hash: "8d969eef6ecad3c29a3a629280e686cf0c3f5d5a86aff3ca12020c923adc6c92", created: "2025-01-01" },
  "USER002": { hash: "481f6cc0511143ccdd7e2d1b1b94faf0a700a8b49cd13922a70b5ae28acaa8c5", created: "2025-01-15" },
  "USER003": { hash: "5906ac361a137e2d286465cd6588ebb5ac3f5d5a86aff3ca12020c923adc6c92", created: "2025-02-01" }
};

var mySessionId = generateSessionId();
var myUser = null;
var channel = null;
var countdownInterval = null;

function hash(str) {
  return CryptoJS.SHA256(str).toString();
}

function generateSessionId() {
  return Date.now().toString(36) + Math.random().toString(36).substr(2) + Math.random().toString(36).substr(2);
}

function show(text, type) {
  var m = document.getElementById('msg');
  m.textContent = text;
  m.className = 'message show ' + type;
}

function showLogoutModal() {
  document.getElementById('logoutModal').classList.add('show');
}

function closeModal() {
  document.getElementById('logoutModal').classList.remove('show');
  if (channel) {
    channel.postMessage({
      type: 'logout',
      user: myUser
    });
  }
  sessionStorage.clear();
  window.location.reload();
}

function showContentModal() {
  document.getElementById('contentModal').classList.add('show');
}

function closeContentModal() {
  document.getElementById('contentModal').classList.remove('show');
}

function showExpiredModal() {
  document.getElementById('expiredModal').classList.add('show');
}

function closeExpiredModal() {
  document.getElementById('expiredModal').classList.remove('show');
  sessionStorage.clear();
  window.location.reload();
}

function checkAccountExpiry(user) {
  var userCred = credentials[user];
  if (!userCred || !userCred.created) {
    return { expired: false, daysLeft: 365 };
  }
  
  var createdDate = new Date(userCred.created);
  var expiryDate = new Date(createdDate);
  expiryDate.setDate(expiryDate.getDate() + config.accountValidityDays);
  
  var now = new Date();
  var timeLeft = expiryDate - now;
  var daysLeft = Math.ceil(timeLeft / (1000 * 60 * 60 * 24));
  
  return {
    expired: timeLeft <= 0,
    expiryDate: expiryDate,
    daysLeft: daysLeft,
    timeLeft: timeLeft
  };
}

function updateCountdown(expiryDate) {
  var now = new Date();
  var timeLeft = expiryDate - now;
  
  if (timeLeft <= 0) {
    clearInterval(countdownInterval);
    document.getElementById('countdownBox').classList.remove('show');
    showExpiredModal();
    return;
  }
  
  var days = Math.floor(timeLeft / (1000 * 60 * 60 * 24));
  var hours = Math.floor((timeLeft % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
  var minutes = Math.floor((timeLeft % (1000 * 60 * 60)) / (1000 * 60));
  
  document.getElementById('days').textContent = days;
  document.getElementById('hours').textContent = hours;
  document.getElementById('minutes').textContent = minutes;
}

function startCountdown(expiryDate) {
  document.getElementById('countdownBox').classList.add('show');
  updateCountdown(expiryDate);
  countdownInterval = setInterval(function() {
    updateCountdown(expiryDate);
  }, 60000);
}

function getNewsCount() {
  try {
    var newsData = JSON.parse(localStorage.getItem('learnx_news') || '[]');
    var last24Hours = Date.now() - (24 * 60 * 60 * 1000);
    var recentNews = newsData.filter(function(item) {
      return item.timestamp > last24Hours;
    });
    return recentNews.length;
  } catch (e) {
    return 0;
  }
}

function updateNewsBadge() {
  var count = getNewsCount();
  var badge = document.getElementById('newsBadge');
  if (count > 0) {
    badge.textContent = count > 99 ? '99+' : count;
    badge.style.display = 'block';
  } else {
    badge.style.display = 'none';
  }
}

function initBroadcastChannel() {
  if (typeof BroadcastChannel === 'undefined') {
    console.warn('BroadcastChannel not supported');
    return null;
  }
  
  channel = new BroadcastChannel('auth_channel');
  
  channel.onmessage = function(event) {
    var data = event.data;
    
    if (data.type === 'new_login' && data.user === myUser && data.sessionId !== mySessionId) {
      showLogoutModal();
    }
    
    if (data.type === 'check_session' && data.user === myUser) {
      channel.postMessage({
        type: 'session_response',
        user: myUser,
        sessionId: mySessionId,
        timestamp: Date.now()
      });
    }
  };
  
  return channel;
}

function checkForExistingSessions(user) {
  return new Promise(function(resolve) {
    if (!channel) {
      resolve(false);
      return;
    }
    
    var responses = [];
    var checkTimeout;
    
    var responseHandler = function(event) {
      var data = event.data;
      if (data.type === 'session_response' && data.user === user) {
        responses.push(data);
      }
    };
    
    channel.addEventListener('message', responseHandler);
    
    channel.postMessage({
      type: 'check_session',
      user: user
    });
    
    checkTimeout = setTimeout(function() {
      channel.removeEventListener('message', responseHandler);
      resolve(responses.length > 0);
    }, 500);
  });
}

function notifyNewLogin(user) {
  if (channel) {
    channel.postMessage({
      type: 'new_login',
      user: user,
      sessionId: mySessionId,
      timestamp: Date.now()
    });
  }
}

async function verify() {
  var user = document.getElementById('username').value.trim().toUpperCase();
  var pass = document.getElementById('password').value;
  
  if (!user || !pass) {
    show('Please enter both access code and password', 'error');
    return;
  }
  
  var stored = credentials[user];
  
  if (!stored) {
    show('Invalid access code or password', 'error');
    document.getElementById('password').value = '';
    return;
  }
  
  var expiryCheck = checkAccountExpiry(user);
  
  if (expiryCheck.expired) {
    show('â ï¸ Your account has expired. Please contact admin for renewal.', 'error');
    document.getElementById('password').value = '';
    showExpiredModal();
    return;
  }
  
  if (hash(pass) === stored.hash) {
    var hasActiveSession = await checkForExistingSessions(user);
    
    if (hasActiveSession) {
      show('â ï¸ This account is already active on another tab/window', 'error');
      document.getElementById('password').value = '';
      return;
    }
    
    show('â Access granted! Redirecting...', 'success');
    
    myUser = user;
    
    var expires = new Date();
    expires.setHours(expires.getHours() + config.sessionTimeout);
    
    sessionStorage.setItem('auth', 'true');
    sessionStorage.setItem('user', user);
    sessionStorage.setItem('sessionId', mySessionId);
    sessionStorage.setItem('expires', expires.getTime());
    sessionStorage.setItem('accountExpiry', expiryCheck.expiryDate.getTime());
    
    notifyNewLogin(user);
    
    setTimeout(function() {
      window.location.href = config.redirectUrl;
    }, 1200);
  } else {
    show('Invalid access code or password', 'error');
    document.getElementById('password').value = '';
  }
}

document.getElementById('username').addEventListener('keypress', function(e) {
  if (e.key === 'Enter') document.getElementById('password').focus();
});

document.getElementById('password').addEventListener('keypress', function(e) {
  if (e.key === 'Enter') verify();
});

window.addEventListener('beforeunload', function() {
  if (channel && myUser) {
    channel.postMessage({
      type: 'logout',
      user: myUser
    });
  }
});

var auth = sessionStorage.getItem('auth');
var user = sessionStorage.getItem('user');
var sessionId = sessionStorage.getItem('sessionId');
var exp = sessionStorage.getItem('expires');
var accountExp = sessionStorage.getItem('accountExpiry');

if (auth === 'true' && user && sessionId && exp && new Date().getTime() < parseInt(exp)) {
  myUser = user;
  mySessionId = sessionId;
  initBroadcastChannel();
  
  if (accountExp) {
    var expiryDate = new Date(parseInt(accountExp));
    var now = new Date();
    
    if (now >= expiryDate) {
      sessionStorage.clear();
      showExpiredModal();
    } else {
      startCountdown(expiryDate);
    }
  }
  
  updateNewsBadge();
  setInterval(updateNewsBadge, 60000);
} else {
  initBroadcastChannel();
  updateNewsBadge();
  setInterval(updateNewsBadge, 60000);
}
</script>

</body>
</html>

